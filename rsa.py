
import modular
import random

def generar_claves(min_primo, max_primo):
    lista = modular.lista_primos(min_primo, max_primo)
    p1 = random.choice(lista)
    lista.remove(p1)
    p2 = random.choice(lista)

    n = p1 * p2
    phi_n = (p1 - 1) * (p2 - 1)
    d = random.randint(1, phi_n)
    while modular.mcd(d, phi_n) != 1:
        d = random.randint(1, phi_n)
    e = modular.inversa_mod_p(d, phi_n)

    return n, e, d

def aplicar_padding(m, digitos_padding):
    m = str(m)
    for i in range(digitos_padding):
        m = m + str(random.randint(0, 9))
    return int(m)

def eliminar_padding(m, digitos_padding):
    m = str(m)
    for i in range(digitos_padding):
        m = m[:-1]
    return int(m)

def cifrar_rsa(m, n, e, digitos_padding):
    m = aplicar_padding(m, digitos_padding)
    c = modular.potencia_mod_p(m, e, n)
    return c

def descifrar_rsa(c, n, d, digitos_padding):
    m = modular.potencia_mod_p(c, d, n)
    m = eliminar_padding(m, digitos_padding)
    return m

def cifrar_cadena_rsa(s, n, e, digitos_padding):
    s_unicode = [ord(c) for c in s]
    c = [cifrar_rsa(m, n, e, digitos_padding) for m in s_unicode]
    return c

def descifrar_cadena_rsa(cList, n, d, digitos_padding):
    m_unicode = [descifrar_rsa(c, n, d, digitos_padding) for c in cList]
    s = str()
    for i in m_unicode:
        s += chr(i)
    return s

def romper_clave(n, e):
    factores = modular.factorizar(n)
    #Si el diccionario tiene más de 2 claves, entonces n no es el producto de dos primos
    if len(factores) > 2:
        return None
    else:
        #Obtengo los dos primos
        p1 = list(factores.keys())[0]
        p2 = list(factores.keys())[1]
        #Calculo phi(n)
        phi_n = (p1-1)*(p2-1)
        d = modular.inversa_mod_p(e, phi_n)
        return d

def ataque_texto_plano(cList, n, e):
    TODOS_LOS_CARACTERES = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 ,.¿?¡!áéíóúÁÉÍÓÚñÑ-_'()[]"
    caracteres_devueltos = cifrar_cadena_rsa(TODOS_LOS_CARACTERES, n, e, 0) 
    s = str()
    for c in cList:
        try:
            s += TODOS_LOS_CARACTERES[caracteres_devueltos.index(c)]
        except:
            s += "❓"
    return s

def main():
    #Quiero enviar hola y luego descifrarlo
    s = "hola"
    n, e, d = generar_claves(100, 1000)
    cList = cifrar_cadena_rsa(s, n, e, 2)
    print("Cad cifrada: ", cList)
    s = descifrar_cadena_rsa(cList, n, d, 2)
    print("Cad descifrada: ", s)

    #Ahora intento romper la clave
    print("\nATAQUE")
    s = "hola"
    n, e, d = generar_claves(100, 1000)
    cList = cifrar_cadena_rsa(s, n, e, 0)
    print("Cad cifrada: ", cList)
    s = ataque_texto_plano(cList, n, e)
    print("Cad descifrada: ", s)

    print("\nATACAMOS A X")
    X_n = 28282590191348679547
    X_e = 15780653617344828671
    X_m ="9319749784910798525 4842569036581725503 20980190400660326533 6214149683214360481 4842569036581725503 20980190400660326533 2593648050233843527 6214149683214360481 28272142292129573062 18608120468201529368 12717565007171403561 20980190400660326533 21857556142816524701 22749440338291372804 20980190400660326533 2593648050233843527 18608120468201529368 20980190400660326533 2645277767775864437 18608120468201529368 4842569036581725503 15792170862416865726 2184632374345176968 18608120468201529368 22323999023705590489 20980190400660326533 21857556142816524701 22749440338291372804 20980190400660326533 15792170862416865726 6214149683214360481 19874418287555674497 14776330905304766194 20980190400660326533 4842569036581725503 14776330905304766194 14356227971113333857 1523370796302586613 12717565007171403561 22749440338291372804 20980190400660326533 4842569036581725503 14776330905304766194 20980190400660326533 28144107392132733343 6214149683214360481 25777023659433805948 22749440338291372804 12717565007171403561 14776330905304766194 20980190400660326533 18608120468201529368 15792170862416865726 14776330905304766194 12717565007171403561 21857556142816524701 18608120468201529368 12717565007171403561 14356227971113333857 22749440338291372804 22323999023705590489 20980190400660326533 4842569036581725503 14776330905304766194 20980190400660326533 2184632374345176968 18608120468201529368 20980190400660326533 14356227971113333857 6214149683214360481 15792170862416865726 2184632374345176968 14776330905304766194 20980190400660326533 27735342771309849241 25777023659433805948 22749440338291372804 14356227971113333857 20554480259726460599 14776330905304766194 20980190400660326533 28144107392132733343 6214149683214360481 22749440338291372804 20980190400660326533 9752506857902334135 25777023659433805948 9752506857902334135 7861010050314625994 18608120468201529368 20980190400660326533 6214149683214360481 4842569036581725503 20980190400660326533 2184632374345176968 25777023659433805948 21857556142816524701 18608120468201529368 2593648050233843527 28272142292129573062 14776330905304766194 20980190400660326533 21857556142816524701 22749440338291372804 20980190400660326533 2593648050233843527 14776330905304766194 1311789732010833948 20980190400660326533 21857556142816524701 22749440338291372804 20980190400660326533 2593648050233843527 18608120468201529368 4842569036581725503 19746169375983354497 18608120468201529368 20980190400660326533 22749440338291372804 4842569036581725503 20980190400660326533 18608120468201529368 1311789732010833948 27735342771309849241 25777023659433805948 2593648050233843527 2593648050233843527 22749440338291372804 12717565007171403561 14776330905304766194 22323999023705590489 20980190400660326533 18608120468201529368 21857556142816524701 18608120468201529368 12717565007171403561 28272142292129573062 18608120468201529368 20980190400660326533 18608120468201529368 4842569036581725503 27735342771309849241 25777023659433805948 28272142292129573062 6214149683214360481 18608120468201529368 22323999023705590489 20980190400660326533 12717565007171403561 14776330905304766194 15792170862416865726 7861010050314625994 4842569036581725503 20980190400660326533 14237643400138015579 2593648050233843527 18608120468201529368 15792170862416865726 14776330905304766194 20980190400660326533 19874418287555674497 20980190400660326533 28272142292129573062 18608120468201529368 2593648050233843527 28272142292129573062 14776330905304766194 20980190400660326533 15792170862416865726 14776330905304766194 12717565007171403561 12717565007171403561 22749440338291372804 21857556142816524701 14776330905304766194 12717565007171403561 12601521022934061392 20980190400660326533 21272876599726765219 4842569036581725503 18608120468201529368 20980190400660326533 14776330905304766194 2593648050233843527 2593648050233843527 18608120468201529368 20980190400660326533 21857556142816524701 22749440338291372804 20980190400660326533 18608120468201529368 2593648050233843527 28272142292129573062 14776330905304766194 20980190400660326533 14356227971113333857 10413804642095300346 1311789732010833948 20980190400660326533 9752506857902334135 18608120468201529368 15792170862416865726 18608120468201529368 20980190400660326533 28144107392132733343 6214149683214360481 22749440338291372804 20980190400660326533 15792170862416865726 18608120468201529368 12717565007171403561 4842569036581725503 22749440338291372804 12717565007171403561 14776330905304766194 22323999023705590489 20980190400660326533 1311789732010833948 18608120468201529368 2593648050233843527 20554480259726460599 25777023659433805948 15792170862416865726 6578013938662589726 4842569036581725503 20980190400660326533 2593648050233843527 18608120468201529368 1311789732010833948 20980190400660326533 14356227971113333857 10413804642095300346 1311789732010833948 20980190400660326533 4842569036581725503 14776330905304766194 15792170862416865726 2184632374345176968 22749440338291372804 1311789732010833948 22323999023705590489 20980190400660326533 21857556142816524701 6214149683214360481 22749440338291372804 2593648050233843527 14776330905304766194 1311789732010833948 20980190400660326533 19874418287555674497 20980190400660326533 28144107392132733343 6214149683214360481 22749440338291372804 1523370796302586613 12717565007171403561 18608120468201529368 4842569036581725503 27735342771309849241 14776330905304766194 1311789732010833948 20980190400660326533 2593648050233843527 14776330905304766194 1311789732010833948 20980190400660326533 1311789732010833948 10413804642095300346 1523370796302586613 18608120468201529368 21857556142816524701 14776330905304766194 1311789732010833948 22323999023705590489 20980190400660326533 2593648050233843527 18608120468201529368 4842569036581725503 27735342771309849241 22749440338291372804 26206620538814045720 18608120468201529368 1311789732010833948 20980190400660326533 2593648050233843527 14776330905304766194 1311789732010833948 20980190400660326533 9752506857902334135 25777023659433805948 22749440338291372804 12717565007171403561 4842569036581725503 22749440338291372804 1311789732010833948 22323999023705590489 20980190400660326533 18608120468201529368 2593648050233843527 28272142292129573062 14475833729579280389 4842569036581725503 20980190400660326533 20554480259726460599 18608120468201529368 2593648050233843527 14776330905304766194 14356227971113333857 25777023659433805948 4842569036581725503 14776330905304766194 20980190400660326533 21857556142816524701 22749440338291372804 20980190400660326533 18608120468201529368 6668148546026848177 18608120468201529368 21857556142816524701 25777023659433805948 21857556142816524701 6214149683214360481 12717565007171403561 18608120468201529368 20980190400660326533 2593648050233843527 14776330905304766194 1311789732010833948 20980190400660326533 21857556142816524701 14776330905304766194 14356227971113333857 25777023659433805948 4842569036581725503 28272142292129573062 14776330905304766194 1311789732010833948 22323999023705590489 20980190400660326533 15792170862416865726 14776330905304766194 4842569036581725503 1311789732010833948 6214149683214360481 14356227971113333857 7861010050314625994 18608120468201529368 4842569036581725503 20980190400660326533 2593648050233843527 18608120468201529368 1311789732010833948 20980190400660326533 27735342771309849241 12717565007171403561 22749440338291372804 1311789732010833948 20980190400660326533 20554480259726460599 18608120468201529368 12717565007171403561 27735342771309849241 22749440338291372804 1311789732010833948 20980190400660326533 21857556142816524701 22749440338291372804 20980190400660326533 1311789732010833948 6214149683214360481 20980190400660326533 2184632374345176968 18608120468201529368 15792170862416865726 25777023659433805948 22749440338291372804 4842569036581725503 21857556142816524701 18608120468201529368 12601521022934061392"
    #En un lugar de la Mancha, de cuyo nombre no quiero acordarme, no ha mucho tiempo que vivía un hidalgo de los de lanza en astillero, adarga antigua, rocín flaco y galgo corredor. Una olla 
    #de algo más vaca que carnero, salpicón las más noches, duelos y quebrantos los sábados, lantejas los viernes, algún palomino de añadidura los domingos, consumían las tres partes de su hacienda.
    X_m = X_m.split()
    X_m = [int(i) for i in X_m]
    #Ataco el texto plano
    s = ataque_texto_plano(X_m, X_n, X_e)
    print(s)


if __name__ == "__main__":
    main()